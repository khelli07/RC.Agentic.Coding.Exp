services:
  mongo:
    image: mongo:6.0
    restart: unless-stopped
    command:
      - mongod
      - --replSet
      - rs0
      - --bind_ip_all
      - --oplogSize
      - "128"
    volumes:
      - mongo_data:/data/db

  mongo-init-replica:
    image: mongo:6.0
    restart: "no"
    depends_on:
      - mongo
    entrypoint:
      - bash
      - -lc
      - |
        for i in {1..30}; do
          mongosh --host mongo --eval "try { rs.status() } catch (e) { rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'mongo:27017'}]}) }" && exit 0
          sleep 2
        done
        exit 1

  rocketchat:
    image: registry.rocket.chat/rocketchat/rocket.chat:6.13.0
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_started
      mongo-init-replica:
        condition: service_completed_successfully
    environment:
      MONGO_URL: mongodb://mongo:27017/rocketchat?replicaSet=rs0
      MONGO_OPLOG_URL: mongodb://mongo:27017/local?replicaSet=rs0
      ROOT_URL: http://localhost:3000
      PORT: "3000"
      DEPLOY_METHOD: docker
      DEPLOY_PLATFORM: docker
      INITIAL_USER: "yes"
      ADMIN_USERNAME: admin
      ADMIN_NAME: Admin User
      ADMIN_EMAIL: admin@example.com
      ADMIN_PASS: admin12345
      OVERWRITE_SETTING_Apps_Framework_Enabled: "true"
      OVERWRITE_SETTING_Apps_Framework_Development_Mode: "true"
      OVERWRITE_SETTING_Show_Setup_Wizard: completed
    ports:
      - "3000:3000"

volumes:
  mongo_data:
